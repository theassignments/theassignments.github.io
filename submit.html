<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Submit Assignment â€” TheAssignment</title>

<style>
body{margin:0;font-family:Inter,Arial;background:#f5f7fb;padding:18px}
.wrap{max-width:1000px;margin:auto;background:#fff;padding:18px;border-radius:12px}
form{display:grid;gap:10px}
input,textarea,select{padding:10px;border-radius:8px;border:1px solid #e6eef8}
.row{display:flex;gap:10px}
.col{flex:1}
.btn{background:#2b8aef;color:#fff;padding:10px;border:none;border-radius:8px;cursor:pointer}
.order{border:1px solid #eef2f8;padding:12px;border-radius:8px;margin-bottom:12px}
.small{font-size:13px;color:#6b7280}
@media(max-width:800px){.row{flex-direction:column}}
</style>
</head>

<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Submit Your Assignment</h2>
    <div>
      <span id="userInfo" class="small"></span>
      <button id="btnSignOut" class="btn" style="display:none">Sign out</button>
    </div>
  </div>

  <!-- FORM (NO onsubmit here) -->
  <form id="submitForm">
    <input id="title" placeholder="Assignment title" required>

    <div class="row">
      <div class="col">
        <select id="subject" required>
          <option value="">Select Subject</option>
          <option>Economics</option>
          <option>Computer Science</option>
          <option>Business</option>
          <option>Physics</option>
        </select>
      </div>
      <div class="col">
        <input id="pages" type="number" placeholder="Pages">
      </div>
    </div>

    <label class="small">Deadline</label>
    <input id="deadline" type="datetime-local">

    <label class="small">Detailed Instructions</label>
    <textarea id="instructions" rows="4"></textarea>

    <label class="small">Upload Files</label>
    <input id="files" type="file" multiple>

    <div class="row">
      <div class="col">
        <select id="deliveryOpt">
          <option value="digital">Digital Only</option>
          <option value="home">Home Delivery</option>
          <option value="pickup">Pickup Point</option>
        </select>
      </div>
      <div class="col">
        <input id="deliveryAddr" placeholder="Delivery Address">
      </div>
    </div>

    <button id="submitBtn" class="btn" type="submit">Submit Assignment</button>
    <div id="statusText" class="small"></div>
  </form>

  <h3>Your Orders</h3>
  <div id="ordersList">Loading...</div>
</div>

<!-- FIREBASE SDKs (v8 â€“ NON MODULE, SAFE) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
/* ðŸ”¥ FIREBASE INIT */
firebase.initializeApp({
  apiKey: "AIzaSyAwRT7JwLOXgpaA2qCfGKr2b6-yugEFryY",
  authDomain: "theassignments-2a79c.firebaseapp.com",
  projectId: "theassignments-2a79c",
  storageBucket: "theassignments-2a79c.appspot.com"
});

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ðŸ” AUTH CHECK */
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="login-signup.html";
    return;
  }
  userInfo.innerText = user.email;
  btnSignOut.style.display="inline-block";
  loadOrders(user.uid);
});

btnSignOut.onclick = ()=>{
  auth.signOut();
  location.href="login-signup.html";
};

/* âœ… FORM SUBMIT HANDLER (THIS FIXES YOUR CLICK ISSUE) */
document.getElementById("submitForm")
  .addEventListener("submit", submitOrder);

async function submitOrder(e){
  e.preventDefault();

  const user = auth.currentUser;
  if(!user){
    alert("Not logged in");
    return;
  }

  submitBtn.disabled = true;
  submitBtn.innerText = "Submitting...";
  statusText.innerText = "Uploading & saving order...";

  try{
    const uploadedFiles = [];
    const files = document.getElementById("files").files;
    const basePath = "orders/" + user.uid + "/" + Date.now();

    for(let f of files){
      const ref = storage.ref(basePath + "/" + f.name);
      const snap = await ref.put(f);
      const url = await snap.ref.getDownloadURL();
      uploadedFiles.push({name:f.name, url});
    }

    await db.collection("orders").add({
      userId: user.uid,
      userEmail: user.email,
      title: title.value,
      subject: subject.value,
      pages: pages.value || null,
      deadline: deadline.value || null,
      instructions: instructions.value || null,
      deliveryOpt: deliveryOpt.value,
      deliveryAddr: deliveryAddr.value || null,
      files: uploadedFiles,
      status: "received",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    submitForm.reset();
    alert("Order submitted successfully âœ…");

  }catch(err){
    console.error(err);
    alert("Error: " + err.message);
  }

  submitBtn.disabled = false;
  submitBtn.innerText = "Submit Assignment";
  statusText.innerText = "";
}

/* ðŸ“¦ LOAD USER ORDERS */
function loadOrders(uid){
  db.collection("orders")
    .where("userId","==",uid)
    .orderBy("createdAt","desc")
    .onSnapshot(snap=>{
      ordersList.innerHTML="";
      if(snap.empty){
        ordersList.innerHTML="<p class='small'>No orders yet</p>";
        return;
      }

      snap.forEach(doc=>{
        const o = doc.data();

        let filesHTML="";
        if(o.files && o.files.length){
          filesHTML=o.files.map(f=>`<a target="_blank" href="${f.url}">${f.name}</a>`).join(", ");
        }

        let finalFile = o.solutionFileURL
          ? `<div><b>Final File:</b> <a target="_blank" href="${o.solutionFileURL}">Download</a></div>`
          : "";

        ordersList.innerHTML+=`
          <div class="order">
            <strong>${o.title}</strong>
            <div><b>Status:</b> ${o.status}</div>
            <div><b>Subject:</b> ${o.subject}</div>
            <div><b>Pages:</b> ${o.pages || "-"}</div>
            <div><b>Deadline:</b> ${o.deadline || "-"}</div>
            <div><b>Instructions:</b><br><small>${o.instructions || "-"}</small></div>
            <div><b>Delivery:</b> ${o.deliveryOpt}</div>
            ${o.deliveryAddr ? `<div><b>Address:</b> ${o.deliveryAddr}</div>` : ""}
            ${filesHTML ? `<div><b>Your Files:</b> ${filesHTML}</div>` : ""}
            ${finalFile}
          </div>
        `;
      });
    });
}
</script>
</body>
</html>
